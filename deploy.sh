#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะดะตะฟะปะพั Calorista API

set -e

echo "๐ ะะฐัะธะฝะฐะตะผ ะดะตะฟะปะพะน Calorista API..."

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต Docker
if ! command -v docker &> /dev/null; then
    echo "โ Docker ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะฃััะฐะฝะพะฒะธัะต Docker ะธ ะฟะพะฟัะพะฑัะนัะต ัะฝะพะฒะฐ."
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต docker-compose
if ! command -v docker-compose &> /dev/null; then
    echo "โ Docker Compose ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะฃััะฐะฝะพะฒะธัะต Docker Compose ะธ ะฟะพะฟัะพะฑัะนัะต ัะฝะพะฒะฐ."
    exit 1
fi

# ะกะพะทะดะฐะตะผ .env ัะฐะนะป ะตัะปะธ ะตะณะพ ะฝะตั
if [ ! -f .env ]; then
    echo "๐ ะกะพะทะดะฐะตะผ .env ัะฐะนะป..."
    cp config.example.env .env
    echo "โ๏ธ  ะะต ะทะฐะฑัะดััะต ะธะทะผะตะฝะธัั ัะตะบัะตัะฝัะต ะบะปััะธ ะฒ .env ัะฐะนะปะต!"
fi

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะต ะบะพะฝัะตะนะฝะตัั
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะต ะบะพะฝัะตะนะฝะตัั..."
docker-compose down

# ะกะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั
echo "๐จ ะกะพะฑะธัะฐะตะผ Docker ะพะฑัะฐะท..."
docker-compose build --no-cache

echo "๐ ะะฐะฟััะบะฐะตะผ ะฟัะธะปะพะถะตะฝะธะต..."
docker-compose up -d

# ะะดะตะผ ะฝะตะผะฝะพะณะพ ะดะปั ะทะฐะฟััะบะฐ
echo "โณ ะะดะตะผ ะทะฐะฟััะบะฐ ะฟัะธะปะพะถะตะฝะธั..."
sleep 10

# ะัะพะฒะตััะตะผ ััะฐััั
echo "๐ ะัะพะฒะตััะตะผ ััะฐััั ะฟัะธะปะพะถะตะฝะธั..."
if curl -f http://localhost:8080/health > /dev/null 2>&1; then
    echo "โ ะัะธะปะพะถะตะฝะธะต ััะฟะตัะฝะพ ะทะฐะฟััะตะฝะพ!"
    echo "๐ API ะดะพัััะฟะตะฝ ะฟะพ ะฐะดัะตัั: http://localhost:8080"
    echo "๐ ะะพะบัะผะตะฝัะฐัะธั: http://localhost:8080/docs"
    echo "๐ Health check: http://localhost:8080/health"
else
    echo "โ ะัะธะปะพะถะตะฝะธะต ะฝะต ะพัะฒะตัะฐะตั. ะัะพะฒะตัััะต ะปะพะณะธ:"
    docker-compose logs
    exit 1
fi

echo "๐ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ ััะฟะตัะฝะพ!" 
#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è Calorista API –±–µ–∑ Docker

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–µ–ø–ª–æ–π Calorista API...${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Swift
if ! command -v swift &> /dev/null; then
    echo -e "${RED}‚ùå Swift –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Swift –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.${NC}"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if [ ! -f .env ]; then
    echo -e "${YELLOW}üìù –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª...${NC}"
    cp config.example.env .env
    echo -e "${YELLOW}‚ö†Ô∏è  –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏ –≤ .env —Ñ–∞–π–ª–µ!${NC}"
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω
echo -e "${YELLOW}üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å...${NC}"
pkill -f "swift run App" 2>/dev/null || true
pkill -f ".build/release/App" 2>/dev/null || true

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
sleep 2

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo -e "${YELLOW}üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...${NC}"
swift build -c release

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ
echo -e "${YELLOW}üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...${NC}"
nohup ./.build/release/App > app.log 2>&1 &
APP_PID=$!

# –°–æ—Ö—Ä–∞–Ω—è–µ–º PID –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
echo $APP_PID > app.pid

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo -e "${YELLOW}‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...${NC}"
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo -e "${YELLOW}üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...${NC}"
for i in {1..10}; do
    if curl -f http://localhost:8080/health > /dev/null 2>&1; then
        echo -e "${GREEN}‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ!${NC}"
        echo -e "${GREEN}üåê API –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:8080${NC}"
        echo -e "${GREEN}üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:8080/docs${NC}"
        echo -e "${GREEN}üíö Health check: http://localhost:8080/health${NC}"
        echo -e "${GREEN}üìã PID –ø—Ä–æ—Ü–µ—Å—Å–∞: $APP_PID${NC}"
        echo -e "${GREEN}üìÑ –õ–æ–≥–∏: tail -f app.log${NC}"
        break
    else
        if [ $i -eq 10 ]; then
            echo -e "${RED}‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ 10 –ø–æ–ø—ã—Ç–æ–∫.${NC}"
            echo -e "${YELLOW}üìã –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:${NC}"
            cat app.log
            exit 1
        fi
        echo -e "${YELLOW}‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/10...${NC}"
        sleep 2
    fi
done

echo -e "${GREEN}üéâ –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!${NC}"
echo ""
echo -e "${BLUE}üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º:${NC}"
echo "  –û—Å—Ç–∞–Ω–æ–≤–∫–∞: ./stop-local.sh"
echo "  –õ–æ–≥–∏: tail -f app.log"
echo "  –°—Ç–∞—Ç—É—Å: ./monitor.sh" 